<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Modbus Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        font-size: 18px;
      }

      button.pushButton {
        padding: 10px 20px;
        font-size: 20px;
        border-radius: 10px;
        cursor: pointer;
        border: 1px solid #aaa;
        background: #e0f0ff;
        box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.2);
        margin-bottom: 5px;
        margin-right: 5px;
      }

      button.pushButton.small {
        font-size: 14px;
        padding: 5px 10px;
      }

      button.pushButton:active {
        box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.2);
      }

      button.iconButton {
        border: none;
        background: none;
        font-size: inherit;
      }

      input {
        font-size: 16px;
        padding: 5px;
        margin-right: 10px;
      }

      h2, h3 {
        margin: 0;
      }

      h2 {
        margin-bottom: 5px;
      }

      textarea {
        font-family: Courier New, monospace;
        font-size: 16px;
        margin-bottom: 5px;
        border: 2px inset #999;
        border-radius: 5px;
        padding: 10px;
      }

      #contents {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
      }

      #left, #right {
        vertical-align: top;
      }

      .section {
        margin-bottom: 50px;
      }

      #programs {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 15px;
      }

      #programError {
        border: 2px solid red;
        border-radius: 10px;
        padding: 10px 20px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
      }
      #programError p {
        margin: 5px 0;
        max-width: 30em;
      }

      #manualEntrySection label {
        display: block;
        margin-bottom: 10px;
      }

      #apiDocLink, #jsonValidation {
        float: right;
      }

      #jsonValidation.valid {
        color: green;
      }

      #jsonValidation.invalid {
        color: red;
      }

      .statusTable {
        margin-left: 10px;
        border: 2px solid #ccc;
        border-radius: 10px;
        padding: 10px 20px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
      }

      .statusHeader th {
        font-weight: normal;
        text-align: center;
        width: 40px;
        font-size: 16px;
      }

      .statusValue td {
        text-align: center;
        width: 40px;
        font-size: 24px;
      }

      .running {
        display: none;
      }

      .programDetails {
        margin-bottom: 10px;
      }

      .program {
        border: 2px solid #ccc;
        border-radius: 10px;
        padding: 10px 20px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        display: inline-block;
      }

      .program h3 {
        margin-bottom: 10px;
      }

      .detailLabel {
        font-weight: bold;
        display: inline-block;
        width: 120px;
        text-align: right;
        margin-right: 10px;
      }

      .error {
        color: red;
      }

      .detail.error .detailValue {
        display: inline-block;
        max-width: 400px;
      }

      .detailLabel {
        vertical-align: top;
      }

      .detail {
        font-size: 14px;
      }

      .detail.path .detailValue {
        font-family: Courier New, monospace;
      }

      .program button {
        margin-left: 20px;
      }

      #response {
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>Modbus Controller</h1>
    <div id="contents">
      <div id="left">
        <div id="programsSection" class="section">
          <h2>Stored Programs <button class="iconButton" onclick="fetchPrograms()">&#x1F501;</button></h2>
          <div id="programs"></div>
        </div>
        <div id="manualEntrySection" class="section">
          <h2>Manual Entry</h2>
          <label for="jsonInput">
            Enter JSON command
            <a id="apiDocLink" href="/swagger" target="_blank">API docs</a>
          </label>
          <textarea id="jsonInput" rows="50" cols="60" onkeyup="checkManualJson()">
{
  "address": "192.168.1.200:4196",
  "commands": [
    [
      {"command": "on", "relay": 1},
      {"command": "off", "relay": 2}
    ]
  ],
  "loops": 1,
  "commandIntervalMillis": 500,
  "debug": false
}
</textarea><br/>
          <div id="jsonValidation"></div>
          <button class="pushButton" onclick="submitJson()">Submit</button>
        </div>
      </div>
      <div id="right">
        <button class="pushButton" onclick="clearResults()">Clear Results</button>

        <div id="statusSection" class="section">
          <h2>Status</h2>
          <div class="running">
            <img src="loading.gif" alt="Loading..."/>
          </div>
          <div id="status">
            No commands executed yet.
          </div>
        </div>
        <div id="resultsSection" class="section">
          <h2>Execution Results</h2>
          <div class="running">
            <img src="loading.gif" alt="Loading..."/>
          </div>
          <div id="results"></div>
        </div>
        <div id="responseSection" class="section">
          <h2>
            JSON response
            <button class="pushButton small" id="toggleResponseButton" onclick="toggleResponse()"
                    style="display:none">Show</button>
          </h2>
          <div class="running">
            <img src="loading.gif" alt="Loading..."/>
          </div>
          <div id="response"></div>
        </div>
      </div>
    </div>

    <script>
      let apiBase = "";

      function checkManualJson() {
        const input = document.getElementById('jsonInput').value;
        let validationDiv = document.getElementById('jsonValidation');
        if (!input.trim()) {
          validationDiv.innerHTML = '';
          validationDiv.className = '';
          return;
        }
        try {
          const program = JSON.parse(input);
          const validationError = validateProgramJson(program);
          if (!validationError) {
            validationDiv.innerHTML = '&#x2705; Valid JSON ';
            validationDiv.className = 'valid';
          } else {
            validationDiv.innerHTML = `Invalid JSON: ${validationError}`;
            validationDiv.className = 'invalid';
          }
        } catch (e) {
          validationDiv.innerHTML = `&#x274C; Invalid JSON: ${e.message}`;
          validationDiv.className = 'invalid';
        }
      }

      function validateProgramJson(obj) {
        if (typeof obj !== "object" || obj === null) {
          return "Top-level value must be an object";
        }

        if (typeof obj.address !== "string" || obj.address.trim() === "") {
          return "Missing or invalid required field: address";
        }

        if (!Array.isArray(obj.commands)) {
          return "Missing or invalid required field: commands";
        }
        for (let i = 0; i < obj.commands.length; i++) {
          const group = obj.commands[i];
          if (!Array.isArray(group)) {
            return `Command group ${i} is not an array`;
          }
          for (let j = 0; j < group.length; j++) {
            const cmd = group[j];
            if (typeof cmd !== "object" || cmd === null) {
              return `Command ${j} in group ${i} is not an object`;
            }
            if (!["on", "off", "toggle"].includes(cmd.command)) {
              return `Command ${j} in group ${i} has invalid command: ${cmd.command}. Valid values are 'on', 'off', 'toggle'.`;
            }
            if (typeof cmd.relay !== "number" || !Number.isInteger(cmd.relay) || cmd.relay <= 0) {
              return `Command ${j} in group ${i} has invalid 'relay' value: ${cmd.relay}. Must be a positive integer.`;
            }
          }
        }

        if (obj.loops !== undefined && (!Number.isInteger(obj.loops) || obj.loops < 0)) {
          return "loops must be a non-negative integer if present";
        }

        if (
          obj.commandIntervalMillis !== undefined &&
          (!Number.isInteger(obj.commandIntervalMillis) || obj.commandIntervalMillis < 0)
        ) {
          return "commandIntervalMillis must be a non-negative integer if present";
        }

        if (obj.debug !== undefined && typeof obj.debug !== "boolean") {
          return "debug must be a boolean if present";
        }

        return null;
      }

      function submitJson() {
        const input = document.getElementById('jsonInput').value;
        fetch(`${apiBase}/run`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: input
        }).then(handleResponse);
        setRunningIndicators(true);
      }

      function clearResults() {
        document.getElementById('status').innerHTML = '';
        document.getElementById('results').innerHTML = '';
        document.getElementById('response').innerHTML = '';
        document.getElementById('toggleResponseButton').style.display = 'none';
      }

      function toggleResponse() {
        const responseDiv = document.getElementById('response');
        const toggleButton = document.getElementById('toggleResponseButton');
        if (responseDiv.style.display === 'block') {
          responseDiv.style.display = 'none';
          toggleButton.textContent = 'Show';
        } else {
          responseDiv.style.display = 'block';
          toggleButton.textContent = 'Hide';
        }
      }

      function handleProgramsError(errorMessage) {
        const container = document.getElementById('programs');
        const programErrorDiv = document.createElement('div');
        programErrorDiv.id = 'programError';
        const errText = document.createElement('p');
        const errMsg = document.createElement('p');
        errText.className = 'error';
        const currentHost = window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
        errText.textContent = `Error loading programs from ${apiBase || currentHost}:`;
        errMsg.className = 'error';
        errMsg.textContent = errorMessage;
        const changeServersDiv = document.createElement('div');
        const changeServersText = document.createElement('p');
        changeServersText.textContent =
          'If you are running this UI on a different host or port than the server, you can provide that information here:';

        changeServersDiv.appendChild(changeServersText);
        const serverInput = document.createElement('input');
        serverInput.type = 'text';
        serverInput.placeholder = apiBase || currentHost;
        changeServersDiv.appendChild(serverInput);

        const setButton = document.createElement('button');
        setButton.className = 'pushButton small';
        setButton.textContent = 'Set Server';
        setButton.onclick = () => {
          apiBase = serverInput.value.trim();
          localStorage.setItem('api-base', apiBase);
          fetchPrograms();
        }
        changeServersDiv.appendChild(setButton);

        programErrorDiv.appendChild(errText);
        programErrorDiv.appendChild(errMsg);
        programErrorDiv.appendChild(changeServersDiv);
        container.appendChild(programErrorDiv);
      }

      function fetchPrograms() {
        const container = document.getElementById('programs');
        container.innerHTML = '';
        fetch(`${apiBase}/programs`)
          .then(res => {
            if (res.ok) {
              return res.json();
            } else {
              return Promise.reject({message: `Server returned status ${res.status} ${res.statusText}`});
            }
          })
          .then(programs => {
            Object.keys(programs).sort().forEach(name => {
              container.appendChild(createButton(name));
            });
          })
          .catch(err => {
            handleProgramsError(err.message || 'Unknown error');
          });
      }

      function onLoad() {
        apiBase = localStorage.getItem("api-base") || ""
        fetchPrograms();
        checkManualJson();
      }

      function createButton(name) {
        const btn = document.createElement('button');
        btn.className = 'pushButton';
        btn.textContent = name;
        btn.onclick = () => {
          fetch(`${apiBase}/run?program=${encodeURIComponent(name)}`, {
            method: 'POST'
          }).then(handleResponse);
          setRunningIndicators(true);
        };
        return btn;
      }

      function setRunningIndicators(visible) {
        const display = visible ? 'block' : 'none';
        const els = document.getElementsByClassName('running');

        Array.from(els).forEach(el => {
          el.style.display = display;
        });
      }

      function handleResponse(res) {
        setRunningIndicators(false);
        res.json().then(resp => {
          const statusDiv = document.getElementById('status');
          statusDiv.innerHTML = '';
          const resultsDiv = document.getElementById('results');
          resultsDiv.innerHTML = '';
          const responseDiv = document.getElementById('response');
          responseDiv.innerHTML = '';

          if (res.ok) {
            renderStatus(resp.status, statusDiv);
            renderResults(resp.results, resultsDiv);
            renderResponse(resp, responseDiv);
          } else {
            const msg = document.createElement('p');
            msg.textContent = `Error: ${resp.message || 'Unknown error'}`;
            resultsDiv.appendChild(msg);
          }
        });
      }

      function renderStatus(status, container) {
        Object.keys(status).forEach(server => {
          const serverDiv = document.createElement('div');
          const title = document.createElement('h3');
          title.textContent = `Server: ${server}`;
          serverDiv.appendChild(title);
          serverDiv.className = 'serverStatus';

          const statusTable = document.createElement('table');
          statusTable.className = 'statusTable';

          const headerRow = document.createElement('tr');
          headerRow.className = 'statusHeader';

          const valueRow = document.createElement('tr');
          valueRow.className = 'statusValue';

          for (const [coilNumber, coilStatus] of Object.entries(status[server].coils)) {
            const headerCell = document.createElement('th');
            headerCell.textContent = coilNumber;
            headerRow.appendChild(headerCell);

            const valueCell = document.createElement('td');
            valueCell.innerHTML = coilStatusIcon(coilStatus);
            valueRow.appendChild(valueCell);
          }

          statusTable.appendChild(headerRow);
          statusTable.appendChild(valueRow);
          serverDiv.appendChild(statusTable);

          container.appendChild(serverDiv);
        });

        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(status, null, 2);
      }

      function coilStatusIcon(status) {
        return status ? '&#x1F4A1;' : '&#x23FC;';
      }

      function renderResults(results, container) {
        results.forEach((result) => {

          const programDiv = document.createElement('div');
          programDiv.className = 'program';
          container.appendChild(programDiv);

          const titleDiv = document.createElement('h3');
          titleDiv.innerHTML = `${result.slug} ${programStatusIcon(result.status)}`
          programDiv.appendChild(titleDiv);

          const detailsDiv = document.createElement('div');
          detailsDiv.className = 'programDetails';
          programDiv.appendChild(detailsDiv);

          if (result.status === 'error') {
            appendDetail(detailsDiv, 'Error', result.error, 'error');
          }

          appendDetail(detailsDiv, 'Execution Time', `${result.executionTimeMillis} ms`, 'executionTime');
          appendDetail(detailsDiv, 'Start Time', new Date(result.startTime).toLocaleString(), 'startTime');

          if (result.program.lastModified) {
            appendDetail(detailsDiv, 'Last Modified', new Date(result.program.lastModified).toLocaleString(), 'lastModified');
          }

          if (result.program.path) {
            appendDetail(detailsDiv, 'Path', result.program.path, 'path');
          }

          const copyButton = document.createElement('button');
          copyButton.innerHTML = '&#x2B05;&#xFE0F; Copy JSON to Manual Entry';
          copyButton.className = 'pushButton small';
          copyButton.onclick = () => {
            const jsonInput = document.getElementById('jsonInput');
            const programCopy = {...result.program};
            delete programCopy.path;
            delete programCopy.lastModified;
            delete programCopy.slug;
            jsonInput.value = JSON.stringify(programCopy, null, 2);
            jsonInput.scrollIntoView({behavior: 'smooth'});
            jsonInput.focus();
          };
          programDiv.appendChild(copyButton);
        });
      }

      function appendDetail(container, label, value, className) {
        const div = document.createElement('div');
        div.className = className ? `detail ${className}` : 'detail';
        const labelSpan = document.createElement('span');
        labelSpan.className = 'detailLabel';
        labelSpan.textContent = `${label}: `;
        div.appendChild(labelSpan);
        const valueSpan = document.createElement('span');
        valueSpan.className = 'detailValue';
        valueSpan.textContent = value;
        div.appendChild(valueSpan);
        container.appendChild(div);
      }

      function programStatusIcon(status) {
        switch (status) {
          case 'success':
            return '&#x2705;'; // check mark
          case 'error':
            return '&#x274C;'; // cross mark
          default:
            return '&#x2753;'; // question mark
        }
      }

      function renderResponse(response, container) {
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(response, null, 2);
        container.appendChild(pre);
        document.getElementById('toggleResponseButton').style.display = 'inline-block';
      }

      onLoad();
    </script>
  </body>
</html>
